## 交易运维平台 TradingOpSystem(TOS)

### 项目简述

#### 项目背景

在高频量化交易场景中，交易系统的环境保密等级较高，且连接方式多样且复杂。由于无法向用户直接提供所有的登录方式，交易服务器集群的交互和运维变得十分困难。同时，交易系统的网络环境复杂，链路带宽有限且稳定性较低。服务集群的交互服务要求高响应性，数据传输服务则要求高带宽和稳定性。为了解决这些问题，交易运维平台TOS应运而生，通过抽象多种网络连接方式为统一接口，并提供简单便捷的交互、传输和运维服务。



#### 项目功能

- 隐藏封装：隐藏了交易系统集群的连接细节，封装成统一接口，直接提供简易可用的接口、功能。具体的，以CLI与API方式提供调用；
- 交互服务：基于网络连接池，提供稳定的高实时交互服务，降低批量操控交易集群的难度；
- 传输服务：基于网络连接池，提供稳定的大带宽传输链路，提高整体传输效率；
- 高可用网络：参考链路聚合思想，构建网络连接池，向上提供面向交互的高实时响应连接与面向传输的大带宽稳定连接；



#### 项目挑战

- 网络连接挑战：网络连接方式多且复杂，不同的交易服务器集群可能使用不同的登录方式，包括但不限于直接连接、堡垒机连接、动态转发等方式，需要提供统一接口进行调度使用；
- 网络链路挑战：连接交易集群的网路链路多，带宽大小、稳定性等各方面存在较大差异，进而导致许多问题；
  - 带宽差异大，小带宽链路容易空转导致浪费，大带宽链路用户多，拥塞风险高，系统整体利用效率低；
  - 使用单一链路进行数据传输需要大量时间，且效率低；
  - 网络的多样性和差异性，导致多链路方案在并行处理、控制协同、控制管理上存在较大挑战；
  - 网络异常时，单链路方案需要切换网络链路，该过程麻烦、易出错，且效率低；
- 交互场景挑战：在大量并发的服务器交互过程中，必须确保交互的实时响应和连续稳定处理；
  - 网络链路的多样性和不稳定性会导致响应时间的不一致性，这为多链路连接方案带来挑战；
  - 过量的并发请求可能导致拥塞、影响链路性能骤降，合理的**负载均衡**是确保交互稳定性和实时性的必要措施；
- 传输场景挑战：大规模的数据传输需要较大的带宽与较高稳定性；
  - 单一链路带宽小，效率低，多链路控制复杂，协调难；
  - 多链路场景下，网络链路带宽差异大，难以统一管理和调度；
  - 大规模数据可能会阻塞网络链路，需要合理有效处理，避免系统陷入瘫痪；



### 项目架构及设计

#### 总架构

![](https://github.com/YMEN6/ProjectShowcase/blob/main/picture/tos1.png?raw=true)

- TOS工作流程
  - 接收请求与权限审计：TOS接收CLI或API调用，并与Central Authentication Service(CAS)协同进行审计，主要包括操作权限与访问控制的验证；
  - 业务功能拆分：完成权限审计后，TOS将业务功能拆分为**交互指令**集合与**传输文件**集合，并配合网络连接池完成相应功能；
  - 交互指令处理：指令集合从网络连接池提供的交互连接队列中获取一个可用连接并板顶，进行独占式交互，和交易服务器集群进行RPC调用和远端操作；
  - 文件传输处理：文件集合从网络连接池获取传输连接队列，并将文件逐个投入队列进行传输，直至完成。在此过程中，队列将被当前文件结合独占；
  - 网络连接池：网络连接池提供交互连接队列与传输连接队列。交互连接队列以每个单独连接为单位，连接之间相互独立，以并行方式工作。传输连接队列以队列为单位，不同队列间相互独立。两者的粒度、控制策略上存在差异；
  - 底层实现：交互连接基于SSH实现RPC调用，传输连接则基于RSYCN进行数据传输；

- RPC实现：SSH
  - 优点：安全性、认证机制与广泛支持；
  - 缺点：额外性能开销
- 文件传输实现：RSYNC
  - 优点：增量传输、带宽优化与灵活性
  - 缺点：初次传输较慢，需要消耗较多的系统资源



#### 网络连接池

![](https://github.com/YMEN6/ProjectShowcase/blob/main/picture/tos2.png?raw=true)

##### 交互连接队列

- 组成
  - 交互连接池默认使用**带宽较小、稳定性较高**的网络链路（如专线）构建连接；
  - 各交易服务器集群拥有各自的交互连接队列，队列**默认长度为16，扩容上限为67**；
    - **带宽计算**：以4M专线为例，设每条SSH连接占用带宽为5KBps，考虑网络异常、拥塞等导致的额外50%负载，则最大稳定连接数为 4Mbps / (1.5 * 5KBps) ≈ 67；
    - **网络冗余**：日常使用中的大部分SSH连接带宽均远小于5KBps，因此上述方案已考虑了网络冗余；
  - 交互连接池定期对底层网络链路进行嗅探，评估其性能，必要时从链路池中获取新的链路进行替换，并**逐批替换**连接队列中的空闲连接；
- 获取交互连接流程：
  - 若交互连接队列不空，直接从队首取出连接并与指令集绑定，完成所有指令调用后，重新插入到队列；
  - 若队列已空且未达到扩容上限，则临时创建新的连接并与指令集进行绑定。完成指令调用后销毁该临时连接；
  - 若连接数已达到扩容上限，为避免链路拥塞与性能恶化，不再创建新连接，直接抛出异常并提示等待一段时间后继续重试；
- 作用
  - 避免资源浪费：提前构建并保留所需连接，避免动态创建和销毁连接带来的性能消耗；
  - 实时性与稳定性保障：周期性嗅探底层链路，提前发现异常并进行链路替换，确保连接的实时性与稳定性；
  - 拥塞避免：限制连接数，避免过量连接对链路性能造成影响；
  - 细粒度控制：以每个连接为单位，而非链路为单位进行控制，尽可能提升效率与实时性（参考HTTP/2相对HTTP/1.1的改进）
  - 隔绝性保护：每个连接各自构建网络链接，避免事故发生时集体崩溃（参考HTTP/2复用同一TCP链路导致的服务崩溃）

##### 传输连接队列

- 组成
  - 链路池为交互连接池保留部分备用链路。传输连接池使用剩余的所有链路进行逻辑上的链路聚合，以提升传输效率；
  - 各交易服务器集群拥有各自的传输连接队列，队列使用大根堆结构存储，以串行化方式提供服务，队列间相互独立；
    - **大根堆结构**：传输时优先使用带宽大、稳定性好的链路，尽快完成传输；
    - **堵塞避免**：防止大规模数据传输堵塞单一链路，数据在传输前切分成适当大小的文件（通常为链路容量的1-2倍）；
    - **传输效率计算**：以10M链路为例，切分大小为10M，考虑TCP头部20B和IP头部20B，传输1GB数据需切分成103块，有效传输率约为96.77%；
  - 传输连接池定期嗅探底层网络，调整各队列内部顺序，移除无效连接并添加新增有效连接；
  - 传输连接队列中的连接在连续多次传输出错（默认5次）时认为暂时失效，将其移除并销毁，待下次状态更新时重新添加；
  - 传输连接队列需要使用交互连接进行控制，以独占方式占有交互连接；
- 文件传输流程：
  - 文件传输前，判断是否需要切分，若文件过大则先切分成多个文件再进行传输；
  - 若传输队列空闲，则绑定队列与当前文件集合，文件集合独占队列直至完成所有传输，随后释放队列；
  - 若队列忙碌，则判断是否已扩容，未扩容时使用链路池的备用链路进行扩容以提升速率；
  - 继续等待获取队列资源；
  - 所有传输完成且无新的传输请求时，移除扩容连接以降低系统整体消耗；
- 作用
  - **避免资源浪费**：同交互连接池；
  - **高速传输**：基于大根堆结构和动态扩容，尽可能加速数据传输；
  - **链路保护**：通过文件切分和多链路并发传输，避免大规模数据堵塞单一链路；
  - **链路聚合**：将多条物理链路聚合成逻辑上的大带宽链路使用；
  - **负载均衡**：通过文件切分和多条链路轮询发送，避免单一链路负载过重，同时利用多条链路并行工作，提高整体效率；
  - **效率与开销的平衡**：必要时调整文件切分大小，虽然引入额外头部开销，但通过多链路并发，规避单一链路性能下降时的超时和重传，更适合多链路方案；



![](https://github.com/YMEN6/ProjectShowcase/blob/main/picture/tos3.png?raw=true)

